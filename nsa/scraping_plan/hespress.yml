# TODO: add IDE support for validation and auto-completion using json-schema to facilitate scraping plans extension

categories:
  description: scraping article links for each category provided as an input
  interactions:
    - do_once: visit_page
      description: visiting the home page for hespress
      inputs:
        url: "https://www.hespress.com/"
    - do_many: category
      description: here we will be scraping data for each category provided as an input
      for_each: "{categories_list}"
      interactions:
        - do_once: click
          inputs:
            selectors:
              - //a[@class='nav-link' and text()="{category}"]
        - do_once: scrape_page
          inputs:
            selectors:
              - //div[@class='cover']
            data_to_get:
              - field_alias: title
                kind: attribute
                relocate:
                  - //a
                name:
                  - title

              - field_alias: image
                kind: attribute
                relocate:
                  - //a//img
                name:
                  - src

              - field_alias: date
                kind: text
                relocate:
                  - //div[@class='card-body']//small

              - field_alias: url
                kind: attribute
                relocate:
                  - //a
                name:
                  - href
                processing:
                  - function: decode_url

              - field_alias: category
                kind: text
                relocate:
                  - //span[@class[contains( ., 'cat')]]
most_viewed_articles:
  description: retrieving most viewed articles on hespress
  interactions:
    - do_once: visit_page
      inputs:
        url: "https://www.hespress.com/all?most_viewed"

    - do_until: no_more
      condition:
        elements_selector: //div[@class='cover']//div[@class='card-body']//small
      interactions:
        - do_once: scrape_page
          inputs:
            selectors:
              - //div[@class='cover']
            include_order: true
            data_to_get:
              - field_alias: title
                kind: attribute
                relocate:
                  - //a
                name:
                  - title

              - field_alias: image
                kind: attribute
                relocate:
                  - //a//img
                name:
                  - src

              - field_alias: date
                kind: text
                relocate:
                  - //div[@class='card-body']//small
                processing:
                  - function: arabic_datetime
                    inputs:
                      year_pattern: \d{4}
                      months_pattern: "[ا-ي]+(?= \\d{4})"
                      days_pattern: \b(?<!:)\d{1,2}(?!:)\b
                      hours_pattern: \d{2}(?=:)
                      minutes_pattern: (?<=:)\d{2}

              - field_alias: url
                kind: attribute
                relocate:
                  - //a
                name:
                  - href
                processing:
                  - function: decode_url

              - field_alias: category
                kind: text
                relocate:
                  - //span[@class[contains( ., 'cat')]]
                processing:
                  - function: strip_whitespaces

        - do_once: use_keyboard
          inputs:
            keys:
              - PageDown
        - do_once: wait_for
          inputs:
            selectors:
              - //div[@class="spinner-border"]
            state: detached
article_details:
  description: scraping article details for each link provided as an input
  interactions:
    - do_many: link
      description: visiting the home page for hespress
      for_each: "{articles_url}"
      interactions:
        - do_once: visit_page
          description: visiting the home page for hespress
          inputs:
            url: "{link}"
        - do_once: scrape_page
          inputs:
            selectors:
              - //section[@class='apost']
            data_to_get:
              - field_alias: article_id
                kind: attribute
                name:
                  - data-postid

              - field_alias: article
                kind: nested_field
                inputs:
                  selectors:
                    - //article

                data_to_get:
                  - field_alias: category
                    kind: text
                    relocate:
                      - //li[@class='breadcrumb-item'][2]/a
                    processing:
                      - function: strip_whitespaces

                  - field_alias: date
                    kind: text
                    relocate:
                      - //span[@class='date-post']
                    processing:
                      - function: arabic_datetime
                        inputs:
                          year_pattern: \d{4}
                          months_pattern: "[ا-ي]+(?= \\d{4})"
                          days_pattern: \b(?<!:)\d{1,2}(?!:)\b
                          hours_pattern: \d{2}(?=:)
                          minutes_pattern: (?<=:)\d{2}

                  - field_alias: title
                    kind: text
                    relocate:
                      - //h1[@class="post-title"]

                  - field_alias: author_name
                    kind: text
                    relocate:
                      - //a[@rel='author']
                    processing:
                      - function: strip_whitespaces

                  - field_alias: author_profile
                    kind: attribute
                    relocate:
                      - //a[@rel='author']
                    name:
                      - href

                  - field_alias: media
                    kind: nested_field
                    data_to_get:
                      - field_alias: video
                        find_all: true
                        kind: nested_field
                        inputs:
                          selectors:
                            - //div[@class='embed-responsive embed-responsive-16by9']
                            - //div[@class[contains(.,'ratio-16')]]
                        data_to_get:
                          - field_alias: url
                            kind: attribute
                            name:
                              - src
                            relocate:
                              - //iframe
                          - field_alias: title
                            kind: attribute
                            relocate:
                              - //iframe
                            name:
                              - title
                          - field_alias: ID
                            kind: generated_field
                            source_field: url
                            processing:
                              - function: extract_from_text
                                inputs:
                                  name: youtube_url_pattern
                                  patterns:
                                    - (?<=embed\/).+(?=\?)
                              - function: extract_from_text
                                inputs:
                                  name: dailymotion_url_pattern
                                  patterns:
                                    - (?![video\/]).*
                          - field_alias: thumbnail
                            kind: attribute
                            name:
                              - style
                              - src
                            iframe: //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
                            relocate:
                              - //img[@class='video_poster_image']
                              - //div[@class="ytp-cued-thumbnail-overlay-image"]
                            processing:
                              - function: extract_from_text
                                inputs:
                                  name: thumbnail_patterm
                                  patterns:
                                    - (?<=url\(\\").*(?=\\)
                                    - (?<=\(").*(?="\))
                          - field_alias: duration
                            kind: text
                            iframe: //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
                            relocate:
                              - //span[@class='ytp-time-duration']
                              - //span[@class='button_play_right']

                      - field_alias: main_image
                        kind: nested_field
                        inputs:
                          selectors:
                            - //figure
                        data_to_get:
                          - field_alias: url
                            kind: attribute
                            relocate:
                              - //img
                            name:
                              - src

                          - field_alias: caption
                            kind: text
                            relocate:
                              - //figcaption

                      - field_alias: other_images
                        kind: attribute
                        find_all: true
                        relocate:
                          - //div[@class='article-content']//img
                        name:
                          - src

                  - field_alias: article_content
                    kind: text
                    find_all: true
                    relocate:
                      - //div[@class='article-content']/*[self::p or self::h2]
                    processing:
                      - function: join_text
                      - function: remove_punctuation
                      - function: remove_arabic_noise
                      - function: strip_whitespaces
                      - function: normalize_arabic_letters
                      - function: remove_repeated_letters
                      - function: remove_stop_words

                  - field_alias: tags
                    find_all: true
                    kind: nested_field
                    inputs:
                      selectors:
                        - //section[@class='box-tags']/a
                    data_to_get:
                      - field_alias: tag
                        kind: text

                      - field_alias: url
                        kind: attribute
                        name:
                          - href
                        processing:
                          - function: decode_url

              - field_alias: comment_section
                kind: nested_field
                inputs:
                  selectors:
                    - //section[@id='comments_section']
                data_to_get:
                  - field_alias: comments_count
                    kind: text
                    relocate:
                      - //span[@class='comments-count-number']
                    processing:
                      - function: strip_whitespaces
                      - function: to_number

                  - field_alias: comments
                    find_all: true
                    kind: nested_field
                    inputs:
                      selectors:
                        - //ul[@id[contains(.,"comment-list")]]/li
                    data_to_get:
                      - field_alias: comment_id
                        kind: attribute
                        relocate:
                          - //div[@id[contains(.,'div-comment')]]
                        name:
                          - id
                        processing:
                          - function: extract_from_text
                            inputs:
                              name: comment_id_patterns
                              patterns:
                                - "(?<=div-comment-).+"
                                - \d+
                      - field_alias: user_name
                        kind: text
                        relocate:
                          - //div[@class='comment-author vcard']/span

                      - field_alias: date
                        kind: text
                        relocate:
                          - //div[@class='comment-date']
                        processing:
                          - function: strip_whitespaces
                          - function: arabic_datetime
                            inputs:
                              year_pattern: \d{4}
                              months_pattern: "[ا-ي]+(?= \\d{4})"
                              days_pattern: \b(?<!:)\d{1,2}(?!:)\b
                              hours_pattern: \d{2}(?=:)
                              minutes_pattern: (?<=:)\d{2}

                      - field_alias: text_content
                        kind: text
                        find_all: true
                        relocate:
                          - //div[@class='comment-text']/p
                        processing:
                          - function: join_text
                          - function: remove_punctuation
                          - function: strip_whitespaces
                          - function: remove_arabic_noise
                          - function: normalize_arabic_letters
                          - function: remove_repeated_letters
                          - function: remove_stop_words

                      - field_alias: total_net_vote
                        kind: text
                        relocate:
                          - //span[@class='comment-recat-number']
                        processing:
                          - function: to_number

              - field_alias: related_articles
                kind: nested_field
                find_all: true
                inputs:
                  selectors:
                    - //div[@class[contains(.,'related')]]//div[@class='overlay card']
                data_to_get:
                  - field_alias: title
                    kind: attribute
                    relocate:
                      - //a
                    name:
                      - title

                  - field_alias: image
                    kind: attribute
                    relocate:
                      - //a//img
                    name:
                      - src

                  - field_alias: date
                    kind: text
                    relocate:
                      - //div[@class='card-body']//small[@class='text-muted time']
                    processing:
                      - function: arabic_datetime
                        inputs:
                          year_pattern: \d{4}
                          months_pattern: "[ا-ي]+(?= \\d{4})"
                          days_pattern: \b(?<!:)\d{1,2}(?!:)\b
                          hours_pattern: \d{2}(?=:)
                          minutes_pattern: (?<=:)\d{2}

                  - field_alias: comments_count
                    kind: text
                    relocate:
                      - //div[@class='card-body']//small[@class='comment-count text-muted ']
                    processing:
                      - function: to_number

                  - field_alias: url
                    kind: attribute
                    relocate:
                      - //a
                    name:
                      - href
                    processing:
                      - function: decode_url

                  - field_alias: article_id
                    kind: generated_field
                    source_field: url
                    processing:
                      - function: extract_from_text
                        inputs:
                          name: article_id_patterns
                          patterns:
                            - (?<=-)\d+

                  - field_alias: category
                    kind: text
                    relocate:
                      - //span[@class[contains( ., 'cat')]]
                    processing:
                      - function: strip_whitespaces
# ----------------------------- TEMPORARY -----------------------------------
article_details_raw:
  description: scraping article details for each link provided as an input
  interactions:
    - do_many: link
      description: visiting the home page for hespress
      for_each: "{articles_url}"
      interactions:
        - do_once: visit_page
          description: visiting the home page for hespress
          inputs:
            url: "{link}"
        - do_once: scrape_page
          inputs:
            selectors:
              - //section[@class='apost']
            data_to_get:
              - field_alias: article_id
                kind: attribute
                name:
                  - data-postid

              - field_alias: article
                kind: nested_field
                inputs:
                  selectors:
                    - //article

                data_to_get:
                  - field_alias: category
                    kind: text
                    relocate:
                      - //li[@class='breadcrumb-item'][2]/a

                  - field_alias: date
                    kind: text
                    relocate:
                      - //span[@class='date-post']
                  - field_alias: title
                    kind: text
                    relocate:
                      - //h1[@class="post-title"]

                  - field_alias: author_name
                    kind: text
                    relocate:
                      - //a[@rel='author']

                  - field_alias: author_profile
                    kind: attribute
                    relocate:
                      - //a[@rel='author']
                    name:
                      - href

                  - field_alias: media
                    kind: nested_field
                    data_to_get:
                      - field_alias: video
                        kind: nested_field
                        data_to_get:
                          - field_alias: url
                            kind: attribute
                            name:
                              - src
                            relocate:
                              - //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
                          - field_alias: title
                            kind: attribute
                            relocate:
                              - //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
                            name:
                              - title
                          - field_alias: thumbnail
                            kind: attribute
                            name:
                              - style
                              - src
                            iframe: //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
                            relocate:
                              - //img[@class='video_poster_image']
                              - //div[@class="ytp-cued-thumbnail-overlay-image"]
                            processing:
                              - function: extract_from_text
                                inputs:
                                  patterns:
                                    - (?<=url\(\\").*(?=\\)
                                    - (?<=\(").*(?="\))
                          - field_alias: duration
                            kind: text
                            iframe: //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
                            relocate:
                              - //span[@class='ytp-time-duration']
                              - //span[@class='button_play_right']

                      - field_alias: main_image
                        kind: nested_field
                        inputs:
                          selectors:
                            - //figure
                        data_to_get:
                          - field_alias: url
                            kind: attribute
                            relocate:
                              - //img
                            name:
                              - src

                          - field_alias: caption
                            kind: text
                            relocate:
                              - //figcaption

                      - field_alias: other_images
                        kind: attribute
                        find_all: true
                        relocate:
                          - //div[@class='article-content']//img
                        name:
                          - src

                  - field_alias: article_content
                    kind: text
                    find_all: true
                    relocate:
                      - //div[@class='article-content']/*[self::p or self::h2]
                    processing:
                      - function: join_text

                  - field_alias: tags
                    find_all: true
                    kind: nested_field
                    inputs:
                      selectors:
                        - //section[@class='box-tags']/a
                    data_to_get:
                      - field_alias: tag
                        kind: text

                      - field_alias: url
                        kind: attribute
                        name:
                          - href

              - field_alias: comment_section
                kind: nested_field
                inputs:
                  selectors:
                    - //section[@id='comments_section']
                data_to_get:
                  - field_alias: comments_count
                    kind: text
                    relocate:
                      - //span[@class='comments-count-number']

                  - field_alias: comments
                    find_all: true
                    kind: nested_field
                    inputs:
                      selectors:
                        - //ul[@id[contains(.,"comment-list")]]/li
                    data_to_get:
                      - field_alias: comment_id
                        kind: attribute
                        relocate:
                          - //div[@id[contains(.,'div-comment')]]
                        name:
                          - id
                      - field_alias: user_name
                        kind: text
                        relocate:
                          - //div[@class='comment-author vcard']/span

                      - field_alias: date
                        kind: text
                        relocate:
                          - //div[@class='comment-date']

                      - field_alias: text_content
                        kind: text
                        find_all: true
                        relocate:
                          - //div[@class='comment-text']/p
                        processing:
                          - function: join_text

                      - field_alias: total_net_vote
                        kind: text
                        relocate:
                          - //span[@class='comment-recat-number']

              - field_alias: related_articles
                kind: nested_field
                find_all: true
                inputs:
                  selectors:
                    - //div[@class[contains(.,'related')]]//div[@class='overlay card']
                data_to_get:
                  - field_alias: title
                    kind: attribute
                    relocate:
                      - //a
                    name:
                      - title

                  - field_alias: image
                    kind: attribute
                    relocate:
                      - //a//img
                    name:
                      - src

                  - field_alias: date
                    kind: text
                    relocate:
                      - //div[@class='card-body']//small[@class='text-muted time']
                  - field_alias: comments_count
                    kind: text
                    relocate:
                      - //div[@class='card-body']//small[@class='comment-count text-muted ']
                  - field_alias: url
                    kind: attribute
                    relocate:
                      - //a
                    name:
                      - href

                  - field_alias: category
                    kind: text
                    relocate:
                      - //span[@class[contains( ., 'cat')]]
# ---------------------------------------------------------------------------------
# test_iframe:
#   interactions:
#     - do_many: link
#       description: visiting the home page for hespress
#       for_each:
#         - https://www.hespress.com/%D9%84%D8%A7%D8%B9%D8%A8-%D9%8A%D9%87%D8%AF%D9%8A-%D8%B3%D8%A7%D8%B9%D8%A9-%D8%B1%D9%88%D9%84%D9%8A%D9%83%D8%B3%D9%84%D9%85%D8%B4%D8%AC%D8%B9-1029780.html
#         - https://www.hespress.com/%d9%85%d8%b5%d8%a7%d8%b9%d8%a8-%d9%81%d9%8a-%d9%82%d8%b7%d8%a7%d8%b9-%d8%a7%d9%84%d8%af%d9%88%d8%a7%d8%ac%d9%86-1028442.html
#         - https://www.hespress.com/%d8%aa%d9%82%d8%b1%d9%8a%d8%b1-%d9%8a%d9%83%d8%b4%d9%81-%d8%aa%d8%af%d8%a7%d8%b9%d9%8a%d8%a7%d8%aa-%d9%81%d8%a7%d8%af%d8%ad%d8%a9-%d9%84%d9%85%d8%aa%d8%b6%d8%b1%d8%b1%d9%8a%d9%86-%d9%85%d9%86-%d8%ad-1027754.html
#       interactions:
#         - do_once: visit_page
#           description: visiting the home page for hespress
#           inputs:
#             url: "{link}"
#         - do_once: scrape_page
#           inputs:
#             selectors:
#               - //section[@class='apost']
#             data_to_get:
#               - field_alias: media
#                 kind: nested_field
#                 data_to_get:
#                   - field_alias: video
#                     kind: nested_field
#                     inputs:
#                       selectors:
#                         - //div[@class='embed-responsive embed-responsive-16by9']
#                     data_to_get:
#                       - field_alias: url
#                         kind: attribute
#                         name:
#                           - src
#                         relocate:
#                           - //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
#                       - field_alias: title
#                         kind: attribute
#                         relocate:
#                           - //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
#                         name:
#                           - title
#                       - field_alias: thumbnail
#                         kind: attribute
#                         name:
#                           - style
#                           - src
#                         iframe: //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
#                         relocate:
#                           - //img[@class='video_poster_image']
#                           - //div[@class="ytp-cued-thumbnail-overlay-image"]
#                         processing:
#                           - function: extract_from_text
#                             inputs:
#                               patterns:
#                                 - (?<=url\(\\").*(?=\\)
#                                 - (?<=\(").*(?="\))
#                       - field_alias: duration
#                         kind: text
#                         iframe: //iframe[@src[contains(.,'youtube.com/embed')] or @src[contains(.,'dailymotion.com/embed/video')]]
#                         relocate:
#                           - //span[@class='button_play_right']
#                           - //span[@class='ytp-time-duration']
